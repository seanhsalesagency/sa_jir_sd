<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Brands Company - Service Desk</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f5f7;
            color: #172b4d;
            line-height: 1.42857143;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            background: white;
            padding: 30px;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(9,30,66,0.25);
        }
        
        h1 {
            color: #0052cc;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .subtitle {
            color: #5e6c84;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        
        .status-indicators {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 3px;
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .status-loading {
            background: #ddd6fe;
            color: #6b46c1;
        }
        
        .status-success {
            background: #dcfce7;
            color: #16a34a;
        }
        
        .status-error {
            background: #fecaca;
            color: #dc2626;
        }
        
        .forms-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .form-card {
            background: white;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(9,30,66,0.25);
            transition: box-shadow 0.15s;
            overflow: hidden;
            border-left: 4px solid #0052cc;
        }
        
        .form-card:hover {
            box-shadow: 0 8px 25px -8px rgba(9,30,66,0.3);
        }
        
        .form-header {
            padding: 20px 20px 0;
        }
        
        .form-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #172b4d;
            margin-bottom: 8px;
        }
        
        .form-description {
            color: #5e6c84;
            font-size: 0.9rem;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .form-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #6b778c;
            margin-bottom: 15px;
        }
        
        .issue-type {
            background: #f4f5f7;
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: 500;
        }
        
        .field-count {
            background: #e3fcef;
            color: #006644;
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: 500;
        }
        
        .form-footer {
            padding: 0 20px 20px;
        }
        
        .form-button {
            width: 100%;
            background: #0052cc;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 3px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        
        .form-button:hover {
            background: #0747a6;
        }
        
        .loading-container {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(9,30,66,0.25);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #ddd6fe;
            border-top: 3px solid #0052cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-container {
            background: white;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(9,30,66,0.25);
            padding: 30px;
            text-align: center;
            border-left: 4px solid #de350b;
        }
        
        .error-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #de350b;
        }
        
        .error-details {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            text-align: left;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        
        .retry-button, .debug-button {
            background: #0052cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            font-size: 0.9rem;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.15s;
        }
        
        .retry-button:hover, .debug-button:hover {
            background: #0747a6;
        }
        
        .debug-button {
            background: #6c757d;
        }
        
        .debug-button:hover {
            background: #5a6268;
        }
        
        .stats-container {
            background: white;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(9,30,66,0.25);
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 600;
            color: #0052cc;
            display: block;
        }
        
        .stat-label {
            color: #5e6c84;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .categories {
            margin-bottom: 30px;
        }
        
        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .category-tab {
            background: white;
            border: 1px solid #dfe1e6;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.9rem;
        }
        
        .category-tab:hover {
            background: #f4f5f7;
        }
        
        .category-tab.active {
            background: #0052cc;
            color: white;
            border-color: #0052cc;
        }
        
        .project-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 10px 15px;
            margin: 10px 0;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Smart Brands Company</h1>
            <p class="subtitle">Service Desk Portal</p>
            <div class="status-indicators" id="statusIndicators">
                <span class="status-indicator status-loading">
                    <span>🔄 Loading...</span>
                </span>
            </div>
        </header>

        <div id="statsContainer" class="stats-container" style="display: none;">
            <div class="stat-item">
                <span id="totalForms" class="stat-number">0</span>
                <div class="stat-label">Available Forms</div>
            </div>
            <div class="stat-item">
                <span id="totalFields" class="stat-number">0</span>
                <div class="stat-label">Total Fields</div>
            </div>
            <div class="stat-item">
                <span id="formSource" class="stat-number">API</span>
                <div class="stat-label">Data Source</div>
            </div>
        </div>

        <div id="projectInfo" class="project-info" style="display: none;">
            <strong>Project:</strong> <span id="projectName">Loading...</span> | 
            <strong>Key:</strong> <span id="projectKey">Loading...</span> | 
            <strong>Source:</strong> <span id="dataSource">Loading...</span>
        </div>

        <div id="categoriesContainer" class="categories" style="display: none;">
            <div class="category-tabs" id="categoryTabs">
                <!-- Categories will be populated dynamically -->
            </div>
        </div>

        <main id="mainContent">
            <div class="loading-container">
                <div class="spinner"></div>
                <h2 style="color: #172b4d; margin-bottom: 10px;">Loading Service Desk Forms...</h2>
                <p style="color: #5e6c84;">Connecting to Jira and retrieving available forms...</p>
            </div>
        </main>
    </div>

    <script>
        const LAMBDA_URL = 'https://s4imtdlzhdq7cnnmor7bx4vcmm0banfo.lambda-url.us-east-1.on.aws/';
        const CREATE_TICKET_URL = 'https://s4imtdlzhdq7cnnmor7bx4vcmm0banfo.lambda-url.us-east-1.on.aws/';
        
        let allForms = [];
        let currentFilter = 'all';
        let projectInfo = null;
        
        async function loadForms() {
            const statusIndicators = document.getElementById('statusIndicators');
            const mainContent = document.getElementById('mainContent');
            const statsContainer = document.getElementById('statsContainer');
            const categoriesContainer = document.getElementById('categoriesContainer');
            const projectInfoDiv = document.getElementById('projectInfo');
            
            try {
                console.log('🚀 Loading dynamic forms from Jira...');
                
                statusIndicators.innerHTML = `
                    <span class="status-indicator status-loading">
                        <span>📡 Fetching Forms...</span>
                    </span>
                `;
                
                const response = await fetch(`${LAMBDA_URL}?action=getForms`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('📊 Forms data received:', data);
                
                if (data.success && data.forms && data.forms.length > 0) {
                    allForms = data.forms;
                    projectInfo = data.projectInfo;
                    
                    // Update status
                    statusIndicators.innerHTML = `
                        <span class="status-indicator status-success">
                            ✅ ${data.totalForms} Forms Loaded
                        </span>
                        <span class="status-indicator status-success">
                            🔗 ${data.source.replace(/_/g, ' ')}
                        </span>
                    `;
                    
                    // Update project info
                    document.getElementById('projectName').textContent = projectInfo.projectName || 'Unknown';
                    document.getElementById('projectKey').textContent = projectInfo.projectKey || 'Unknown';
                    document.getElementById('dataSource').textContent = data.source.replace(/_/g, ' ');
                    projectInfoDiv.style.display = 'block';
                    
                    // Update stats
                    const totalFields = data.forms.reduce((sum, form) => sum + (form.fields?.length || 0), 0);
                    document.getElementById('totalForms').textContent = data.totalForms;
                    document.getElementById('totalFields').textContent = totalFields;
                    document.getElementById('formSource').textContent = data.source.replace(/_/g, ' ');
                    
                    // Build dynamic categories from actual issue types
                    buildDynamicCategories(data.forms);
                    
                    // Show stats and categories
                    statsContainer.style.display = 'flex';
                    categoriesContainer.style.display = 'block';
                    
                    // Render forms
                    renderForms(allForms);
                    
                } else {
                    throw new Error(data.message || data.error || 'No forms available');
                }
                
            } catch (error) {
                console.error('❌ Error loading forms:', error);
                showError(error, statusIndicators, mainContent);
            }
        }
        
        function buildDynamicCategories(forms) {
            const categoryTabs = document.getElementById('categoryTabs');
            
            // Get unique issue types from forms
            const issueTypes = [...new Set(forms.map(form => form.issueTypeName))].sort();
            
            // Build category tabs HTML
            let tabsHtml = `
                <button class="category-tab active" onclick="filterForms('all')">
                    All Forms (${forms.length})
                </button>
            `;
            
            issueTypes.forEach(issueType => {
                const count = forms.filter(form => form.issueTypeName === issueType).length;
                tabsHtml += `
                    <button class="category-tab" onclick="filterForms('${issueType}')">
                        ${issueType} (${count})
                    </button>
                `;
            });
            
            categoryTabs.innerHTML = tabsHtml;
            console.log('📂 Built dynamic categories:', issueTypes);
        }
        
        function renderForms(forms) {
            const mainContent = document.getElementById('mainContent');
            
            if (!forms || forms.length === 0) {
                mainContent.innerHTML = `
                    <div class="error-container">
                        <div class="error-title">No Forms Available</div>
                        <p>No forms match the current filter.</p>
                    </div>
                `;
                return;
            }
            
            let formsHtml = '<div class="forms-container">';
            
            forms.forEach(form => {
                formsHtml += `
                    <div class="form-card" data-issue-type="${form.issueTypeName}">
                        <div class="form-header">
                            <h3 class="form-title">${form.title}</h3>
                            <p class="form-description">${form.description}</p>
                            <div class="form-meta">
                                <span class="issue-type">${form.issueTypeName}</span>
                                <span class="field-count">${form.fields?.length || 0} fields</span>
                            </div>
                        </div>
                        <div class="form-footer">
                            <button class="form-button" onclick="openForm('${form.id}', '${form.title}', '${form.formType}')">
                                Create ${form.title}
                            </button>
                        </div>
                    </div>
                `;
            });
            
            formsHtml += '</div>';
            mainContent.innerHTML = formsHtml;
        }
        
        function filterForms(category) {
            // Update active tab
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Filter forms
            if (category === 'all') {
                renderForms(allForms);
            } else {
                const filteredForms = allForms.filter(form => form.issueTypeName === category);
                renderForms(filteredForms);
            }
            
            currentFilter = category;
        }
        
        function openForm(formId, formTitle, formType) {
            const form = allForms.find(f => f.id === formId);
            
            // Show form details
            let fieldsInfo = '';
            if (form.fields && form.fields.length > 0) {
                fieldsInfo = '\n\nFields:\n' + form.fields.map(field => 
                    `• ${field.label} (${field.type}${field.required ? ', required' : ''})`
                ).join('\n');
            }
            
            alert(`Opening: ${formTitle}\n\nForm ID: ${formId}\nForm Type: ${formType}\nProject: ${projectInfo?.projectKey || 'Unknown'}\nIssue Type: ${form.issueTypeName}${fieldsInfo}\n\n🚧 Full form interface coming next!\n\nThis will integrate with your existing ticket creation system.`);
            
            console.log('Form to open:', form);
        }
        
        function showError(error, statusIndicators, mainContent) {
            statusIndicators.innerHTML = `
                <span class="status-indicator status-error">
                    ❌ Error Loading Forms
                </span>
            `;
            
            mainContent.innerHTML = `
                <div class="error-container">
                    <div class="error-title">⚠️ Unable to Load Forms</div>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <div class="error-details">
                        <strong>Troubleshooting:</strong><br>
                        1. Check if your Jira project exists and is accessible<br>
                        2. Verify API authentication and permissions<br>
                        3. Try the debug tools below for more information
                    </div>
                    <button class="retry-button" onclick="location.reload()">
                        🔄 Retry
                    </button>
                    <button class="debug-button" onclick="runDiagnostics()">
                        🔍 Run Diagnostics
                    </button>
                    <button class="debug-button" onclick="discoverProjects()">
                        📋 Discover Projects
                    </button>
                </div>
            `;
        }
        
        async function runDiagnostics() {
            try {
                const response = await fetch(`${LAMBDA_URL}?action=discoverProjects`);
                const data = await response.json();
                console.log('🔍 Diagnostics:', data);
                
                alert('Diagnostics completed! Check browser console for details.\n\n' +
                      'Summary:\n' +
                      `• Auth: ${data.discovery?.authTest?.success ? '✅' : '❌'}\n` +
                      `• Projects found: ${data.discovery?.allProjects?.count || 0}\n` +
                      `• Smart Brands projects: ${data.discovery?.smartBrandsProjects?.count || 0}`);
            } catch (error) {
                alert('Diagnostics failed: ' + error.message);
            }
        }
        
        async function discoverProjects() {
            try {
                const response = await fetch(`${LAMBDA_URL}?action=discoverProjects`);
                const data = await response.json();
                
                if (data.success && data.discovery?.allProjects?.projects) {
                    const projects = data.discovery.allProjects.projects;
                    const projectList = projects.map(p => `${p.key}: ${p.name}`).join('\n');
                    alert(`Available Projects (${projects.length}):\n\n${projectList}`);
                } else {
                    alert('Failed to discover projects: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Project discovery failed: ' + error.message);
            }
        }
        
        // Load forms when page loads
        document.addEventListener('DOMContentLoaded', loadForms);
        
        console.log('🎯 Smart Brands Service Desk Portal loaded (Dynamic Version)');
        console.log('Forms API:', LAMBDA_URL);
        console.log('Ticket Creation API:', CREATE_TICKET_URL);
    </script>
</body>
</html>
